<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Pfizer Mailer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #fff; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .card { background: #1a1a1a; border: 2px solid #667eea; border-radius: 10px; padding: 25px; margin-bottom: 25px; }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #2a2a2a; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #667eea; color: white; font-weight: bold; }
        tr:hover { background: #333; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #333; color: white; border: 1px solid #555; border-radius: 6px; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2); }
        .status-active { color: #28a428; font-weight: bold; }
        .status-inactive { color: #ff6b6b; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row > * { flex: 1; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 10px; text-align: center; }
        .loading { text-align: center; padding: 20px; color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Pfizer Mailer</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏ –∏ –∫–ª—é—á–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –∫–ª—é—á–µ–π</h3>
                <p id="totalKeys">0</p>
            </div>
            <div class="stat-card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
                <p id="activeKeys">0</p>
            </div>
            <div class="stat-card">
                <h3>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</h3>
                <p id="activatedKeys">0</p>
            </div>
        </div>

        <div class="card">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>–ö–ª—é—á:</label>
                    <input type="text" id="newKey" placeholder="PFIZER-XXXX-XXXX-XXXX-XXXX" pattern="^PFIZER-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$" required>
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª—é—á–∞:</label>
                    <input type="text" id="keyName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á" maxlength="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è:</label>
                    <input type="datetime-local" id="expiresAt">
                </div>
                <div class="form-group">
                    <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</label>
                    <textarea id="notes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" rows="2"></textarea>
                </div>
            </div>
            <button class="btn" onclick="createLicense()">üéØ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
        </div>

        <div class="card">
            <h2>üìã –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π</h2>
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π...</div>
            <div id="licensesList"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/licenses';
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin`);
                const licenses = await response.json();
                
                const total = licenses.length;
                const active = licenses.filter(l => l.is_active).length;
                const activated = licenses.filter(l => l.hwid).length;
                
                document.getElementById('totalKeys').textContent = total;
                document.getElementById('activeKeys').textContent = active;
                document.getElementById('activatedKeys').textContent = activated;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏
        async function loadLicenses() {
            try {
                const response = await fetch(`${API_BASE}/admin`);
                const licenses = await response.json();
                
                let html = `
                    <table>
                        <tr>
                            <th>–ö–ª—é—á</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>HWID</th>
                            <th>–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th>
                            <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                `;
                
                licenses.forEach(license => {
                    const isExpired = license.expires_at && new Date(license.expires_at) < new Date();
                    const statusClass = !license.is_active || isExpired ? 'status-inactive' : 'status-active';
                    const statusText = !license.is_active ? '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' : 
                                     isExpired ? '–ò—Å—Ç–µ–∫' : 
                                     license.hwid ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
                    
                    html += `
                        <tr>
                            <td><strong>${license.key}</strong></td>
                            <td>
                                <input type="text" value="${license.key_name}" 
                                       onchange="updateLicense('${license._id}', 'key_name', this.value)"
                                       style="background: transparent; border: 1px dashed #667eea;">
                            </td>
                            <td class="${statusClass}">${statusText}</td>
                            <td title="${license.hwid || ''}">${license.hwid ? license.hwid.substring(0, 16) + '...' : '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}</td>
                            <td>${license.activation_date ? new Date(license.activation_date).toLocaleDateString('ru-RU') : '-'}</td>
                            <td>${license.expires_at ? new Date(license.expires_at).toLocaleDateString('ru-RU') : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ'}</td>
                            <td>
                                <button class="btn" onclick="toggleLicense('${license._id}', ${!license.is_active})">
                                    ${license.is_active ? 'üö´ –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                                </button>
                                <button class="btn btn-danger" onclick="deleteLicense('${license._id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('licensesList').innerHTML = html;
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                document.getElementById('loading').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–π';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–π:', error);
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á
        async function createLicense() {
            const key = document.getElementById('newKey').value;
            const keyName = document.getElementById('keyName').value;
            const expiresAt = document.getElementById('expiresAt').value;
            const notes = document.getElementById('notes').value;
            
            if (!key) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        key, 
                        key_name: keyName || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
                        expires_at: expiresAt,
                        notes: notes 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newKey').value = '';
                    document.getElementById('keyName').value = '';
                    document.getElementById('expiresAt').value = '';
                    document.getElementById('notes').value = '';
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    loadLicenses();
                    loadStats();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞: ' + error);
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á
        async function updateLicense(id, field, value) {
            try {
                const updateData = { [field]: value };
                await fetch(`${API_BASE}/admin/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞:', error);
            }
        }
        
        // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–ª—é—á
        async function toggleLicense(id, newStatus) {
            try {
                await fetch(`${API_BASE}/admin/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                loadLicenses();
                loadStats();
                alert(newStatus ? '‚úÖ –ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!' : 'üö´ –ö–ª—é—á –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞: ' + error);
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á
        async function deleteLicense(id) {
            if (!confirm('‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/admin/${id}`, { method: 'DELETE' });
                alert('‚úÖ –ö–ª—é—á —É–¥–∞–ª–µ–Ω!');
                loadLicenses();
                loadStats();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞: ' + error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadLicenses();
            loadStats();
        });
    </script>
</body>
</html>